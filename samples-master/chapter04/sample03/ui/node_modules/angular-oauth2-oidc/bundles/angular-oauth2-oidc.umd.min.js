!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("angular-oauth2-oidc",["exports","@angular/core","@angular/common","@angular/common/http","rxjs","rxjs/operators"],t):t((e=e||self)["angular-oauth2-oidc"]={},e.ng.core,e.ng.common,e.ng.common.http,e.rxjs,e.rxjs.operators)}(this,function(e,t,n,r,o,i){"use strict";var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function a(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function c(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function u(e,t){return function(n,r){t(n,r,e)}}function l(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function h(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{c(r.next(e))}catch(t){i(t)}}function a(e){try{c(r["throw"](e))}catch(t){i(t)}}function c(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,a)}c((r=r.apply(e,t||[])).next())})}function d(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),"throw":a(1),"return":a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r["return"]:i[0]?r["throw"]||((o=r["return"])&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(a){i=[6,a],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function p(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function f(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(n=i["return"])&&n.call(i)}finally{if(o)throw o.error}}return s}var g=function(){return function(){this.preventClearHashAfterLogin=!1}}(),m=function(){return function(){}}(),v=function(){return function(){}}(),y=function(){function e(){this.data=new Map}return e.prototype.getItem=function(e){return this.data.get(e)},e.prototype.removeItem=function(e){this.data["delete"](e)},e.prototype.setItem=function(e,t){this.data.set(e,t)},e=c([t.Injectable()],e)}(),k=function(){return function(){}}();function w(e){var t=e.replace(/\-/g,"+").replace(/\_/g,"/");return decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function _(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var b=function(){return function(){}}(),T=function(){function e(){}return e.prototype.validateAtHash=function(e){return h(this,void 0,void 0,function(){var t,n,r,o,i;return d(this,function(s){switch(s.label){case 0:return t=this.inferHashAlgorithm(e.idTokenHeader),[4,this.calcHash(e.accessToken,t)];case 1:return n=s.sent(),r=n.substr(0,n.length/2),o=_(r),i=e.idTokenClaims.at_hash.replace(/=/g,""),o!==i&&(console.error("exptected at_hash: "+o),console.error("actual at_hash: "+i)),[2,o===i]}})})},e.prototype.inferHashAlgorithm=function(e){var t=e.alg;if(!t.match(/^.S[0-9]{3}$/))throw new Error("Algorithm not supported: "+t);return"sha-"+t.substr(2)},e}(),S=function(){function e(){}return e.prototype.getHashFragmentParams=function(e){var t=e||window.location.hash;if(0!==(t=decodeURIComponent(t)).indexOf("#"))return{};var n=t.indexOf("?");return t=n>-1?t.substr(n+1):t.substr(1),this.parseQueryString(t)},e.prototype.parseQueryString=function(e){var t,n,r,o,i,s,a,c={};if(null===e)return c;t=e.split("&");for(var u=0;u<t.length;u++)-1===(r=(n=t[u]).indexOf("="))?(o=n,i=null):(o=n.substr(0,r),i=n.substr(r+1)),s=decodeURIComponent(o),a=decodeURIComponent(i),"/"===s.substr(0,1)&&(s=s.substr(1)),c[s]=a;return c},e=c([t.Injectable()],e)}(),I=function(){return function(e){this.type=e}}(),C=function(e){function t(t,n){void 0===n&&(n=null);var r=e.call(this,t)||this;return r.info=n,r}return a(t,e),t}(I),A=function(e){function t(t,n){void 0===n&&(n=null);var r=e.call(this,t)||this;return r.info=n,r}return a(t,e),t}(I),H=function(e){function t(t,n,r){void 0===r&&(r=null);var o=e.call(this,t)||this;return o.reason=n,o.params=r,o}return a(t,e),t}(I),E=function(){return function(e){this.clientId="",this.redirectUri="",this.postLogoutRedirectUri="",this.loginUrl="",this.scope="openid profile",this.resource="",this.rngUrl="",this.oidc=!0,this.requestAccessToken=!0,this.options=null,this.issuer="",this.logoutUrl="",this.clearHashAfterLogin=!0,this.tokenEndpoint=null,this.userinfoEndpoint=null,this.responseType="",this.showDebugInformation=!1,this.silentRefreshRedirectUri="",this.silentRefreshMessagePrefix="",this.silentRefreshShowIFrame=!1,this.siletRefreshTimeout=2e4,this.silentRefreshTimeout=2e4,this.dummyClientSecret=null,this.requireHttps="remoteOnly",this.strictDiscoveryDocumentValidation=!0,this.jwks=null,this.customQueryParams=null,this.silentRefreshIFrameName="angular-oauth-oidc-silent-refresh-iframe",this.timeoutFactor=.75,this.sessionChecksEnabled=!1,this.sessionCheckIntervall=3e3,this.sessionCheckIFrameUrl=null,this.sessionCheckIFrameName="angular-oauth-oidc-check-session-iframe",this.disableAtHashCheck=!1,this.skipSubjectCheck=!1,this.useIdTokenHintForSilentRefresh=!1,this.skipIssuerCheck=!1,this.nonceStateSeparator=";",this.useHttpBasicAuth=!1,this.waitForTokenInMsec=0,this.disablePKCE=!1,this.openUri=function(e){location.href=e},e&&Object.assign(this,e)}}(),P=function(){function e(){}return e.prototype.encodeKey=function(e){return encodeURIComponent(e)},e.prototype.encodeValue=function(e){return encodeURIComponent(e)},e.prototype.decodeKey=function(e){return decodeURIComponent(e)},e.prototype.decodeValue=function(e){return decodeURIComponent(e)},e}(),U=function(){return function(){}}(),x=function(){function e(){}return e.prototype.calcHash=function(e,t){return h(this,void 0,void 0,function(){var n,r,o;return d(this,function(i){switch(i.label){case 0:return n=new TextEncoder,r=n.encode(e),[4,window.crypto.subtle.digest(t,r)];case 1:return o=i.sent(),[2,this.toHashString(o)]}})})},e.prototype.toHashString=function(e){var t,n,r=new Uint8Array(e),o="";try{for(var i=p(r),s=i.next();!s.done;s=i.next()){var a=s.value;o+=String.fromCharCode(a)}}catch(c){t={error:c}}finally{try{s&&!s.done&&(n=i["return"])&&n.call(i)}finally{if(t)throw t.error}}return o},e=c([t.Injectable()],e)}(),j=function(e){function n(t,n,r,i,s,a,c,u){var l=e.call(this)||this;l.ngZone=t,l.http=n,l.config=s,l.urlHelper=a,l.logger=c,l.crypto=u,l.discoveryDocumentLoaded=!1,l.state="",l.eventsSubject=new o.Subject,l.discoveryDocumentLoadedSubject=new o.Subject,l.grantTypesSupported=[],l.inImplicitFlow=!1,l.debug("angular-oauth2-oidc v8-beta"),l.discoveryDocumentLoaded$=l.discoveryDocumentLoadedSubject.asObservable(),l.events=l.eventsSubject.asObservable(),i&&(l.tokenValidationHandler=i),s&&l.configure(s);try{r?l.setStorage(r):"undefined"!=typeof sessionStorage&&l.setStorage(sessionStorage)}catch(h){console.error("No OAuthStorage provided and cannot access default (sessionStorage).Consider providing a custom OAuthStorage implementation in your module.",h)}return l.setupRefreshTimer(),l}return a(n,e),n.prototype.configure=function(e){Object.assign(this,new E,e),this.config=Object.assign({},new E,e),this.sessionChecksEnabled&&this.setupSessionCheck(),this.configChanged()},n.prototype.configChanged=function(){this.setupRefreshTimer()},n.prototype.restartSessionChecksIfStillLoggedIn=function(){this.hasValidIdToken()&&this.initSessionCheck()},n.prototype.restartRefreshTimerIfStillLoggedIn=function(){this.setupExpirationTimers()},n.prototype.setupSessionCheck=function(){var e=this;this.events.pipe(i.filter(function(e){return"token_received"===e.type})).subscribe(function(t){e.initSessionCheck()})},n.prototype.setupAutomaticSilentRefresh=function(e,t,n){var r=this;void 0===e&&(e={}),void 0===n&&(n=!0);var o=!0;this.events.pipe(i.tap(function(e){"token_received"===e.type?o=!0:"logout"===e.type&&(o=!1)}),i.filter(function(e){return"token_expires"===e.type}),i.debounceTime(1e3)).subscribe(function(i){null!=t&&"any"!==t&&i.info!==t||!o||r.refreshInternal(e,n)["catch"](function(e){r.debug("Automatic silent refresh did not work")})}),this.restartRefreshTimerIfStillLoggedIn()},n.prototype.refreshInternal=function(e,t){return this.silentRefreshRedirectUri||"code"!==this.responseType?this.silentRefresh(e,t):this.refreshToken()},n.prototype.loadDiscoveryDocumentAndTryLogin=function(e){var t=this;return void 0===e&&(e=null),this.loadDiscoveryDocument().then(function(n){return t.tryLogin(e)})},n.prototype.loadDiscoveryDocumentAndLogin=function(e){var t=this;return void 0===e&&(e=null),e||(e={state:""}),this.loadDiscoveryDocumentAndTryLogin(e).then(function(e){return!(!t.hasValidIdToken()||!t.hasValidAccessToken())||("code"===t.responseType?t.initCodeFlow():t.initImplicitFlow(),!1)})},n.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.showDebugInformation&&this.logger.debug.apply(this.logger,e)},n.prototype.validateUrlFromDiscoveryDocument=function(e){var t=[],n=this.validateUrlForHttps(e),r=this.validateUrlAgainstIssuer(e);return n||t.push("https for all urls required. Also for urls received by discovery."),r||t.push("Every url in discovery document has to start with the issuer url.Also see property strictDiscoveryDocumentValidation."),t},n.prototype.validateUrlForHttps=function(e){if(!e)return!0;var t=e.toLowerCase();return!1===this.requireHttps||(!(!t.match(/^http:\/\/localhost($|[:\/])/)&&!t.match(/^http:\/\/localhost($|[:\/])/)||"remoteOnly"!==this.requireHttps)||t.startsWith("https://"))},n.prototype.assertUrlNotNullAndCorrectProtocol=function(e,t){if(!e)throw new Error("'"+t+"' should not be null");if(!this.validateUrlForHttps(e))throw new Error("'"+t+"' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).")},n.prototype.validateUrlAgainstIssuer=function(e){return!this.strictDiscoveryDocumentValidation||(!e||e.toLowerCase().startsWith(this.issuer.toLowerCase()))},n.prototype.setupRefreshTimer=function(){var e=this;"undefined"!=typeof window?((this.hasValidIdToken()||this.hasValidAccessToken())&&(this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()),this.tokenReceivedSubscription&&this.tokenReceivedSubscription.unsubscribe(),this.tokenReceivedSubscription=this.events.pipe(i.filter(function(e){return"token_received"===e.type})).subscribe(function(t){e.clearAccessTokenTimer(),e.clearIdTokenTimer(),e.setupExpirationTimers()})):this.debug("timer not supported on this plattform")},n.prototype.setupExpirationTimers=function(){this.hasValidAccessToken()&&this.setupAccessTokenTimer(),this.hasValidIdToken()&&this.setupIdTokenTimer()},n.prototype.setupAccessTokenTimer=function(){var e=this,t=this.getAccessTokenExpiration(),n=this.getAccessTokenStoredAt(),r=this.calcTimeout(n,t);this.ngZone.runOutsideAngular(function(){e.accessTokenTimeoutSubscription=o.of(new A("token_expires","access_token")).pipe(i.delay(r)).subscribe(function(t){e.ngZone.run(function(){e.eventsSubject.next(t)})})})},n.prototype.setupIdTokenTimer=function(){var e=this,t=this.getIdTokenExpiration(),n=this.getIdTokenStoredAt(),r=this.calcTimeout(n,t);this.ngZone.runOutsideAngular(function(){e.idTokenTimeoutSubscription=o.of(new A("token_expires","id_token")).pipe(i.delay(r)).subscribe(function(t){e.ngZone.run(function(){e.eventsSubject.next(t)})})})},n.prototype.clearAccessTokenTimer=function(){this.accessTokenTimeoutSubscription&&this.accessTokenTimeoutSubscription.unsubscribe()},n.prototype.clearIdTokenTimer=function(){this.idTokenTimeoutSubscription&&this.idTokenTimeoutSubscription.unsubscribe()},n.prototype.calcTimeout=function(e,t){var n=Date.now(),r=(t-e)*this.timeoutFactor-(n-e);return Math.max(0,r)},n.prototype.setStorage=function(e){this._storage=e,this.configChanged()},n.prototype.loadDiscoveryDocument=function(e){var t=this;return void 0===e&&(e=null),new Promise(function(n,r){e||((e=t.issuer||"").endsWith("/")||(e+="/"),e+=".well-known/openid-configuration"),t.validateUrlForHttps(e)?t.http.get(e).subscribe(function(e){if(!t.validateDiscoveryDocument(e))return t.eventsSubject.next(new H("discovery_document_validation_error",null)),void r("discovery_document_validation_error");t.loginUrl=e.authorization_endpoint,t.logoutUrl=e.end_session_endpoint||t.logoutUrl,t.grantTypesSupported=e.grant_types_supported,t.issuer=e.issuer,t.tokenEndpoint=e.token_endpoint,t.userinfoEndpoint=e.userinfo_endpoint||t.userinfoEndpoint,t.jwksUri=e.jwks_uri,t.sessionCheckIFrameUrl=e.check_session_iframe||t.sessionCheckIFrameUrl,t.discoveryDocumentLoaded=!0,t.discoveryDocumentLoadedSubject.next(e),t.sessionChecksEnabled&&t.restartSessionChecksIfStillLoggedIn(),t.loadJwks().then(function(r){var o=new C("discovery_document_loaded",{discoveryDocument:e,jwks:r});t.eventsSubject.next(o),n(o)})["catch"](function(e){t.eventsSubject.next(new H("discovery_document_load_error",e)),r(e)})},function(e){t.logger.error("error loading discovery document",e),t.eventsSubject.next(new H("discovery_document_load_error",e)),r(e)}):r("issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).")})},n.prototype.loadJwks=function(){var e=this;return new Promise(function(t,n){e.jwksUri?e.http.get(e.jwksUri).subscribe(function(n){e.jwks=n,e.eventsSubject.next(new C("discovery_document_loaded")),t(n)},function(t){e.logger.error("error loading jwks",t),e.eventsSubject.next(new H("jwks_load_error",t)),n(t)}):t(null)})},n.prototype.validateDiscoveryDocument=function(e){var t;return this.skipIssuerCheck||e.issuer===this.issuer?(t=this.validateUrlFromDiscoveryDocument(e.authorization_endpoint)).length>0?(this.logger.error("error validating authorization_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.end_session_endpoint)).length>0?(this.logger.error("error validating end_session_endpoint in discovery document",t),!1):((t=this.validateUrlFromDiscoveryDocument(e.token_endpoint)).length>0&&this.logger.error("error validating token_endpoint in discovery document",t),(t=this.validateUrlFromDiscoveryDocument(e.userinfo_endpoint)).length>0?(this.logger.error("error validating userinfo_endpoint in discovery document",t),!1):(t=this.validateUrlFromDiscoveryDocument(e.jwks_uri)).length>0?(this.logger.error("error validating jwks_uri in discovery document",t),!1):(this.sessionChecksEnabled&&!e.check_session_iframe&&this.logger.warn("sessionChecksEnabled is activated but discovery document does not contain a check_session_iframe field"),!0)):(this.logger.error("invalid issuer in discovery document","expected: "+this.issuer,"current: "+e.issuer),!1)},n.prototype.fetchTokenUsingPasswordFlowAndLoadUserProfile=function(e,t,n){var o=this;return void 0===n&&(n=new r.HttpHeaders),this.fetchTokenUsingPasswordFlow(e,t,n).then(function(){return o.loadUserProfile()})},n.prototype.loadUserProfile=function(){var e=this;if(!this.hasValidAccessToken())throw new Error("Can not load User Profile without access_token");if(!this.validateUrlForHttps(this.userinfoEndpoint))throw new Error("userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");return new Promise(function(t,n){var o=(new r.HttpHeaders).set("Authorization","Bearer "+e.getAccessToken());e.http.get(e.userinfoEndpoint,{headers:o}).subscribe(function(r){e.debug("userinfo received",r);var o=e.getIdentityClaims()||{};if(e.skipSubjectCheck||!e.oidc||o.sub&&r.sub===o.sub)r=Object.assign({},o,r),e._storage.setItem("id_token_claims_obj",JSON.stringify(r)),e.eventsSubject.next(new C("user_profile_loaded")),t(r);else{n("if property oidc is true, the received user-id (sub) has to be the user-id of the user that has logged in with oidc.\nif you are not using oidc but just oauth2 password flow set oidc to false")}},function(t){e.logger.error("error loading user info",t),e.eventsSubject.next(new H("user_profile_load_error",t)),n(t)})})},n.prototype.fetchTokenUsingPasswordFlow=function(e,t,n){var o=this;return void 0===n&&(n=new r.HttpHeaders),this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint"),new Promise(function(i,s){var a,c,u=new r.HttpParams({encoder:new P}).set("grant_type","password").set("scope",o.scope).set("username",e).set("password",t);if(o.useHttpBasicAuth){var l=btoa(o.clientId+":"+o.dummyClientSecret);n=n.set("Authorization","Basic "+l)}if(o.useHttpBasicAuth||(u=u.set("client_id",o.clientId)),!o.useHttpBasicAuth&&o.dummyClientSecret&&(u=u.set("client_secret",o.dummyClientSecret)),o.customQueryParams)try{for(var h=p(Object.getOwnPropertyNames(o.customQueryParams)),d=h.next();!d.done;d=h.next()){var f=d.value;u=u.set(f,o.customQueryParams[f])}}catch(g){a={error:g}}finally{try{d&&!d.done&&(c=h["return"])&&c.call(h)}finally{if(a)throw a.error}}n=n.set("Content-Type","application/x-www-form-urlencoded"),o.http.post(o.tokenEndpoint,u,{headers:n}).subscribe(function(e){o.debug("tokenResponse",e),o.storeAccessTokenResponse(e.access_token,e.refresh_token,e.expires_in,e.scope),o.eventsSubject.next(new C("token_received")),i(e)},function(e){o.logger.error("Error performing password flow",e),o.eventsSubject.next(new H("token_error",e)),s(e)})})},n.prototype.refreshToken=function(){var e=this;return this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint"),new Promise(function(t,n){var s,a,c=(new r.HttpParams).set("grant_type","refresh_token").set("scope",e.scope).set("refresh_token",e._storage.getItem("refresh_token")),u=(new r.HttpHeaders).set("Content-Type","application/x-www-form-urlencoded");if(e.useHttpBasicAuth){var l=btoa(e.clientId+":"+e.dummyClientSecret);u=u.set("Authorization","Basic "+l)}if(e.useHttpBasicAuth||(c=c.set("client_id",e.clientId)),!e.useHttpBasicAuth&&e.dummyClientSecret&&(c=c.set("client_secret",e.dummyClientSecret)),e.customQueryParams)try{for(var h=p(Object.getOwnPropertyNames(e.customQueryParams)),d=h.next();!d.done;d=h.next()){var f=d.value;c=c.set(f,e.customQueryParams[f])}}catch(g){s={error:g}}finally{try{d&&!d.done&&(a=h["return"])&&a.call(h)}finally{if(s)throw s.error}}e.http.post(e.tokenEndpoint,c,{headers:u}).pipe(i.switchMap(function(t){return t.id_token?o.from(e.processIdToken(t.id_token,t.access_token,!0)).pipe(i.tap(function(t){return e.storeIdToken(t)}),i.map(function(e){return t})):o.of(t)})).subscribe(function(n){e.debug("refresh tokenResponse",n),e.storeAccessTokenResponse(n.access_token,n.refresh_token,n.expires_in,n.scope),e.eventsSubject.next(new C("token_received")),e.eventsSubject.next(new C("token_refreshed")),t(n)},function(t){e.logger.error("Error refreshing token",t),e.eventsSubject.next(new H("token_refresh_error",t)),n(t)})})},n.prototype.removeSilentRefreshEventListener=function(){this.silentRefreshPostMessageEventListener&&(window.removeEventListener("message",this.silentRefreshPostMessageEventListener),this.silentRefreshPostMessageEventListener=null)},n.prototype.setupSilentRefreshEventListener=function(){var e=this;this.removeSilentRefreshEventListener(),this.silentRefreshPostMessageEventListener=function(t){var n=e.processMessageEventMessage(t);e.tryLogin({customHashFragment:n,preventClearHashAfterLogin:!0,customRedirectUri:e.silentRefreshRedirectUri||e.redirectUri})["catch"](function(t){return e.debug("tryLogin during silent refresh failed",t)})},window.addEventListener("message",this.silentRefreshPostMessageEventListener)},n.prototype.silentRefresh=function(e,t){var n=this;void 0===e&&(e={}),void 0===t&&(t=!0);var r=this.getIdentityClaims()||{};if(this.useIdTokenHintForSilentRefresh&&this.hasValidIdToken()&&(e.id_token_hint=this.getIdToken()),!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if("undefined"==typeof document)throw new Error("silent refresh is not supported on this platform");var s=document.getElementById(this.silentRefreshIFrameName);s&&document.body.removeChild(s),this.silentRefreshSubject=r.sub;var a=document.createElement("iframe");a.id=this.silentRefreshIFrameName,this.setupSilentRefreshEventListener();var c=this.silentRefreshRedirectUri||this.redirectUri;this.createLoginUrl(null,null,c,t,e).then(function(e){a.setAttribute("src",e),n.silentRefreshShowIFrame||(a.style.display="none"),document.body.appendChild(a)});var u=this.events.pipe(i.filter(function(e){return e instanceof H}),i.first()),l=this.events.pipe(i.filter(function(e){return"token_received"===e.type}),i.first()),h=o.of(new H("silent_refresh_timeout",null)).pipe(i.delay(this.silentRefreshTimeout));return o.race([u,l,h]).pipe(i.map(function(e){if(e instanceof H)throw"silent_refresh_timeout"===e.type?n.eventsSubject.next(e):(e=new H("silent_refresh_error",e),n.eventsSubject.next(e)),e;return"token_received"===e.type&&(e=new C("silently_refreshed"),n.eventsSubject.next(e)),e})).toPromise()},n.prototype.initImplicitFlowInPopup=function(e){return this.initLoginFlowInPopup(e)},n.prototype.initLoginFlowInPopup=function(e){var t=this;return e=e||{},this.createLoginUrl(null,null,this.silentRefreshRedirectUri,!1,{display:"popup"}).then(function(n){return new Promise(function(r,o){var i,s=window.open(n,"_blank",t.calculatePopupFeatures(e));s?i=window.setInterval(function(){s&&!s.closed||(a(),o(new H("popup_closed",{})))},500):o(new H("popup_blocked",{}));var a=function(){window.clearInterval(i),window.removeEventListener("message",c),null!==s&&s.close(),s=null},c=function(e){var n=t.processMessageEventMessage(e);n&&null!==n?t.tryLogin({customHashFragment:n,preventClearHashAfterLogin:!0,customRedirectUri:t.silentRefreshRedirectUri}).then(function(){a(),r()},function(e){a(),o(e)}):console.log("false event firing")};window.addEventListener("message",c)})})},n.prototype.calculatePopupFeatures=function(e){var t=e.height||470,n=e.width||500,r=window.screenLeft+(window.outerWidth-n)/2;return"location=no,toolbar=no,width="+n+",height="+t+",top="+(window.screenTop+(window.outerHeight-t)/2)+",left="+r},n.prototype.processMessageEventMessage=function(e){var t="#";if(this.silentRefreshMessagePrefix&&(t+=this.silentRefreshMessagePrefix),e&&e.data&&"string"==typeof e.data){var n=e.data;if(n.startsWith(t))return"#"+n.substr(t.length)}},n.prototype.canPerformSessionCheck=function(){return!!this.sessionChecksEnabled&&(this.sessionCheckIFrameUrl?this.getSessionState()?"undefined"!=typeof document:(console.warn("sessionChecksEnabled is activated but there is no session_state"),!1):(console.warn("sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl"),!1))},n.prototype.setupSessionCheckEventListener=function(){var e=this;this.removeSessionCheckEventListener(),this.sessionCheckEventListener=function(t){var n=t.origin.toLowerCase(),r=e.issuer.toLowerCase();if(e.debug("sessionCheckEventListener"),r.startsWith(n)){switch(t.data){case"unchanged":e.handleSessionUnchanged();break;case"changed":e.ngZone.run(function(){e.handleSessionChange()});break;case"error":e.ngZone.run(function(){e.handleSessionError()})}e.debug("got info from session check inframe",t)}else e.debug("sessionCheckEventListener","wrong origin",n,"expected",r)},this.ngZone.runOutsideAngular(function(){window.addEventListener("message",e.sessionCheckEventListener)})},n.prototype.handleSessionUnchanged=function(){this.debug("session check","session unchanged")},n.prototype.handleSessionChange=function(){var e=this;this.eventsSubject.next(new A("session_changed")),this.stopSessionCheckTimer(),this.silentRefreshRedirectUri?(this.silentRefresh()["catch"](function(t){return e.debug("silent refresh failed after session changed")}),this.waitForSilentRefreshAfterSessionChange()):(this.eventsSubject.next(new A("session_terminated")),this.logOut(!0))},n.prototype.waitForSilentRefreshAfterSessionChange=function(){var e=this;this.events.pipe(i.filter(function(e){return"silently_refreshed"===e.type||"silent_refresh_timeout"===e.type||"silent_refresh_error"===e.type}),i.first()).subscribe(function(t){"silently_refreshed"!==t.type&&(e.debug("silent refresh did not work after session changed"),e.eventsSubject.next(new A("session_terminated")),e.logOut(!0))})},n.prototype.handleSessionError=function(){this.stopSessionCheckTimer(),this.eventsSubject.next(new A("session_error"))},n.prototype.removeSessionCheckEventListener=function(){this.sessionCheckEventListener&&(window.removeEventListener("message",this.sessionCheckEventListener),this.sessionCheckEventListener=null)},n.prototype.initSessionCheck=function(){if(this.canPerformSessionCheck()){var e=document.getElementById(this.sessionCheckIFrameName);e&&document.body.removeChild(e);var t=document.createElement("iframe");t.id=this.sessionCheckIFrameName,this.setupSessionCheckEventListener();var n=this.sessionCheckIFrameUrl;t.setAttribute("src",n),t.style.display="none",document.body.appendChild(t),this.startSessionCheckTimer()}},n.prototype.startSessionCheckTimer=function(){var e=this;this.stopSessionCheckTimer(),this.ngZone.runOutsideAngular(function(){e.sessionCheckTimer=setInterval(e.checkSession.bind(e),e.sessionCheckIntervall)})},n.prototype.stopSessionCheckTimer=function(){this.sessionCheckTimer&&(clearInterval(this.sessionCheckTimer),this.sessionCheckTimer=null)},n.prototype.checkSession=function(){var e=document.getElementById(this.sessionCheckIFrameName);e||this.logger.warn("checkSession did not find iframe",this.sessionCheckIFrameName);var t=this.getSessionState();t||this.stopSessionCheckTimer();var n=this.clientId+" "+t;e.contentWindow.postMessage(n,this.issuer)},n.prototype.createLoginUrl=function(e,t,n,r,o){return void 0===e&&(e=""),void 0===t&&(t=""),void 0===n&&(n=""),void 0===r&&(r=!1),void 0===o&&(o={}),h(this,void 0,void 0,function(){var i,s,a,c,u,l,h,g,m,v,y,k,w,_,b,T,S,I;return d(this,function(d){switch(d.label){case 0:return u=this,l=n||this.redirectUri,[4,this.createAndSaveNonce()];case 1:if(h=d.sent(),e=e?h+this.config.nonceStateSeparator+e:h,!this.requestAccessToken&&!this.oidc)throw new Error("Either requestAccessToken or oidc or both must be true");return this.config.responseType?this.responseType=this.config.responseType:this.oidc&&this.requestAccessToken?this.responseType="id_token token":this.oidc&&!this.requestAccessToken?this.responseType="id_token":this.responseType="token",g=u.loginUrl.indexOf("?")>-1?"&":"?",m=u.scope,this.oidc&&!m.match(/(^|\s)openid($|\s)/)&&(m="openid "+m),v=u.loginUrl+g+"response_type="+encodeURIComponent(u.responseType)+"&client_id="+encodeURIComponent(u.clientId)+"&state="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent(l)+"&scope="+encodeURIComponent(m),"code"!==this.responseType||this.disablePKCE?[3,3]:[4,this.createChallangeVerifierPairForPKCE()];case 2:y=f.apply(void 0,[d.sent(),2]),k=y[0],w=y[1],this._storage.setItem("PKCI_verifier",w),v+="&code_challenge="+k,v+="&code_challenge_method=S256",d.label=3;case 3:t&&(v+="&login_hint="+encodeURIComponent(t)),u.resource&&(v+="&resource="+encodeURIComponent(u.resource)),u.oidc&&(v+="&nonce="+encodeURIComponent(h)),r&&(v+="&prompt=none");try{for(_=p(Object.keys(o)),b=_.next();!b.done;b=_.next())I=b.value,v+="&"+encodeURIComponent(I)+"="+encodeURIComponent(o[I])}catch(C){i={error:C}}finally{try{b&&!b.done&&(s=_["return"])&&s.call(_)}finally{if(i)throw i.error}}if(this.customQueryParams)try{for(T=p(Object.getOwnPropertyNames(this.customQueryParams)),S=T.next();!S.done;S=T.next())I=S.value,v+="&"+I+"="+encodeURIComponent(this.customQueryParams[I])}catch(A){a={error:A}}finally{try{S&&!S.done&&(c=T["return"])&&c.call(T)}finally{if(a)throw a.error}}return[2,v]}})})},n.prototype.initImplicitFlowInternal=function(e,t){var n=this;if(void 0===e&&(e=""),void 0===t&&(t=""),!this.inImplicitFlow){if(this.inImplicitFlow=!0,!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");var r={},o=null;"string"==typeof t?o=t:"object"==typeof t&&(r=t),this.createLoginUrl(e,o,null,!1,r).then(this.config.openUri)["catch"](function(e){console.error("Error in initImplicitFlow",e),n.inImplicitFlow=!1})}},n.prototype.initImplicitFlow=function(e,t){var n=this;void 0===e&&(e=""),void 0===t&&(t=""),""!==this.loginUrl?this.initImplicitFlowInternal(e,t):this.events.pipe(i.filter(function(e){return"discovery_document_loaded"===e.type})).subscribe(function(r){return n.initImplicitFlowInternal(e,t)})},n.prototype.resetImplicitFlow=function(){this.inImplicitFlow=!1},n.prototype.callOnTokenReceivedIfExists=function(e){if(e.onTokenReceived){var t={idClaims:this.getIdentityClaims(),idToken:this.getIdToken(),accessToken:this.getAccessToken(),state:this.state};e.onTokenReceived(t)}},n.prototype.storeAccessTokenResponse=function(e,t,n,r){if(this._storage.setItem("access_token",e),r&&this._storage.setItem("granted_scopes",JSON.stringify(r.split("+"))),this._storage.setItem("access_token_stored_at",""+Date.now()),n){var o=1e3*n,i=(new Date).getTime()+o;this._storage.setItem("expires_at",""+i)}t&&this._storage.setItem("refresh_token",t)},n.prototype.tryLogin=function(e){return void 0===e&&(e=null),"code"===this.config.responseType?this.tryLoginCodeFlow(e).then(function(e){return!0}):this.tryLoginImplicitFlow(e)},n.prototype.parseQueryString=function(e){return e&&0!==e.length?("?"===e.charAt(0)&&(e=e.substr(1)),this.urlHelper.parseQueryString(e)):{}},n.prototype.tryLoginCodeFlow=function(e){var t=this;void 0===e&&(e=null);(e=e||{}).customHashFragment?e.customHashFragment.substring(1):window.location.search;var n=this.getCodePartsFromUrl(window.location.search),r=n.code,o=n.state;if(!e.preventClearHashAfterLogin){var i=location.href.replace(/[&\?]code=[^&\$]*/,"").replace(/[&\?]scope=[^&\$]*/,"").replace(/[&\?]state=[^&\$]*/,"").replace(/[&\?]session_state=[^&\$]*/,"");history.replaceState(null,window.name,i)}var s=f(this.parseState(o),2),a=s[0],c=s[1];if(this.state=c,n.error){this.debug("error trying to login"),this.handleLoginError({},n);var u=new H("code_error",{},n);return this.eventsSubject.next(u),Promise.reject(u)}if(!a)return Promise.resolve();if(!this.validateNonce(a)){var l=new H("invalid_nonce_in_state",null);return this.eventsSubject.next(l),Promise.reject(l)}return r?new Promise(function(n,o){t.getTokenFromCode(r,e).then(function(e){n()})["catch"](function(e){o(e)})}):Promise.resolve()},n.prototype.getCodePartsFromUrl=function(e){return e&&0!==e.length?("?"===e.charAt(0)&&(e=e.substr(1)),this.urlHelper.parseQueryString(e)):this.urlHelper.getHashFragmentParams()},n.prototype.getTokenFromCode=function(e,t){var n=(new r.HttpParams).set("grant_type","authorization_code").set("code",e).set("redirect_uri",t.customRedirectUri||this.redirectUri);if(!this.disablePKCE){var o=this._storage.getItem("PKCI_verifier");o?n=n.set("code_verifier",o):console.warn("No PKCI verifier found in oauth storage!")}return this.fetchAndProcessToken(n)},n.prototype.fetchAndProcessToken=function(e){var t=this;this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint");var n=(new r.HttpHeaders).set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){var o=btoa(this.clientId+":"+this.dummyClientSecret);n=n.set("Authorization","Basic "+o)}return this.useHttpBasicAuth||(e=e.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(e=e.set("client_secret",this.dummyClientSecret)),new Promise(function(r,o){var i,s;if(t.customQueryParams)try{for(var a=p(Object.getOwnPropertyNames(t.customQueryParams)),c=a.next();!c.done;c=a.next()){var u=c.value;e=e.set(u,t.customQueryParams[u])}}catch(l){i={error:l}}finally{try{c&&!c.done&&(s=a["return"])&&s.call(a)}finally{if(i)throw i.error}}t.http.post(t.tokenEndpoint,e,{headers:n}).subscribe(function(e){t.debug("refresh tokenResponse",e),t.storeAccessTokenResponse(e.access_token,e.refresh_token,e.expires_in,e.scope),t.oidc&&e.id_token?t.processIdToken(e.id_token,e.access_token).then(function(n){t.storeIdToken(n),t.eventsSubject.next(new C("token_received")),t.eventsSubject.next(new C("token_refreshed")),r(e)})["catch"](function(e){t.eventsSubject.next(new H("token_validation_error",e)),console.error("Error validating tokens"),console.error(e),o(e)}):(t.eventsSubject.next(new C("token_received")),t.eventsSubject.next(new C("token_refreshed")),r(e))},function(e){console.error("Error getting token",e),t.eventsSubject.next(new H("token_refresh_error",e)),o(e)})})},n.prototype.tryLoginImplicitFlow=function(e){var t,n=this;void 0===e&&(e=null),t=(e=e||{}).customHashFragment?this.urlHelper.getHashFragmentParams(e.customHashFragment):this.urlHelper.getHashFragmentParams(),this.debug("parsed url",t);var r=t.state,o=f(this.parseState(r),2),i=o[0],s=o[1];if(this.state=s,t.error){this.debug("error trying to login"),this.handleLoginError(e,t);var a=new H("token_error",{},t);return this.eventsSubject.next(a),Promise.reject(a)}var c=t.access_token,u=t.id_token,l=t.session_state,h=t.scope;if(!this.requestAccessToken&&!this.oidc)return Promise.reject("Either requestAccessToken or oidc (or both) must be true.");if(this.requestAccessToken&&!c)return Promise.resolve(!1);if(this.requestAccessToken&&!e.disableOAuth2StateCheck&&!r)return Promise.resolve(!1);if(this.oidc&&!u)return Promise.resolve(!1);if((this.sessionChecksEnabled&&!l&&this.logger.warn("session checks (Session Status Change Notification) were activated in the configuration but the id_token does not contain a session_state claim"),this.requestAccessToken&&!e.disableOAuth2StateCheck)&&!this.validateNonce(i)){var d=new H("invalid_nonce_in_state",null);return this.eventsSubject.next(d),Promise.reject(d)}return this.requestAccessToken&&this.storeAccessTokenResponse(c,null,t.expires_in||this.fallbackAccessTokenExpirationTimeInSec,h),this.oidc?this.processIdToken(u,c).then(function(t){return e.validationHandler?e.validationHandler({accessToken:c,idClaims:t.idTokenClaims,idToken:t.idToken,state:r}).then(function(e){return t}):t}).then(function(t){return n.storeIdToken(t),n.storeSessionState(l),n.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&(location.hash=""),n.eventsSubject.next(new C("token_received")),n.callOnTokenReceivedIfExists(e),n.inImplicitFlow=!1,!0})["catch"](function(e){return n.eventsSubject.next(new H("token_validation_error",e)),n.logger.error("Error validating tokens"),n.logger.error(e),Promise.reject(e)}):(this.eventsSubject.next(new C("token_received")),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&(location.hash=""),this.callOnTokenReceivedIfExists(e),Promise.resolve(!0))},n.prototype.parseState=function(e){var t=e,n="";if(e){var r=e.indexOf(this.config.nonceStateSeparator);r>-1&&(t=e.substr(0,r),n=e.substr(r+this.config.nonceStateSeparator.length))}return[t,n]},n.prototype.validateNonce=function(e){var t=this._storage.getItem("nonce");if(t!==e){return console.error("Validating access_token failed, wrong state/nonce.",t,e),!1}return!0},n.prototype.storeIdToken=function(e){this._storage.setItem("id_token",e.idToken),this._storage.setItem("id_token_claims_obj",e.idTokenClaimsJson),this._storage.setItem("id_token_expires_at",""+e.idTokenExpiresAt),this._storage.setItem("id_token_stored_at",""+Date.now())},n.prototype.storeSessionState=function(e){this._storage.setItem("session_state",e)},n.prototype.getSessionState=function(){return this._storage.getItem("session_state")},n.prototype.handleLoginError=function(e,t){e.onLoginError&&e.onLoginError(t),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&(location.hash="")},n.prototype.processIdToken=function(e,t,n){var r=this;void 0===n&&(n=!1);var o=e.split("."),i=w(this.padBase64(o[0])),s=JSON.parse(i),a=w(this.padBase64(o[1])),c=JSON.parse(a),u=this._storage.getItem("nonce");if(Array.isArray(c.aud)){if(c.aud.every(function(e){return e!==r.clientId})){var l="Wrong audience: "+c.aud.join(",");return this.logger.warn(l),Promise.reject(l)}}else if(c.aud!==this.clientId){l="Wrong audience: "+c.aud;return this.logger.warn(l),Promise.reject(l)}if(!c.sub){l="No sub claim in id_token";return this.logger.warn(l),Promise.reject(l)}if(this.sessionChecksEnabled&&this.silentRefreshSubject&&this.silentRefreshSubject!==c.sub){l="After refreshing, we got an id_token for another user (sub). Expected sub: "+this.silentRefreshSubject+", received sub: "+c.sub;return this.logger.warn(l),Promise.reject(l)}if(!c.iat){l="No iat claim in id_token";return this.logger.warn(l),Promise.reject(l)}if(!this.skipIssuerCheck&&c.iss!==this.issuer){l="Wrong issuer: "+c.iss;return this.logger.warn(l),Promise.reject(l)}if(!n&&c.nonce!==u){l="Wrong nonce: "+c.nonce;return this.logger.warn(l),Promise.reject(l)}if(this.hasOwnProperty("responseType")&&"code"===this.responseType&&(this.disableAtHashCheck=!0),!this.disableAtHashCheck&&this.requestAccessToken&&!c.at_hash){l="An at_hash is needed!";return this.logger.warn(l),Promise.reject(l)}var h=Date.now(),d=1e3*c.iat,p=1e3*c.exp,f=1e3*(this.clockSkewInSec||600);if(d-f>=h||p+f<=h){l="Token has expired";return console.error(l),console.error({now:h,issuedAtMSec:d,expiresAtMSec:p}),Promise.reject(l)}var g={accessToken:t,idToken:e,jwks:this.jwks,idTokenClaims:c,idTokenHeader:s,loadKeys:function(){return r.loadJwks()}};return this.disableAtHashCheck?this.checkSignature(g).then(function(t){return{idToken:e,idTokenClaims:c,idTokenClaimsJson:a,idTokenHeader:s,idTokenHeaderJson:i,idTokenExpiresAt:p}}):this.checkAtHash(g).then(function(t){if(!r.disableAtHashCheck&&r.requestAccessToken&&!t){var n="Wrong at_hash";return r.logger.warn(n),Promise.reject(n)}return r.checkSignature(g).then(function(t){var n=!r.disableAtHashCheck,o={idToken:e,idTokenClaims:c,idTokenClaimsJson:a,idTokenHeader:s,idTokenHeaderJson:i,idTokenExpiresAt:p};return n?r.checkAtHash(g).then(function(e){if(r.requestAccessToken&&!e){var t="Wrong at_hash";return r.logger.warn(t),Promise.reject(t)}return o}):o})})},n.prototype.getIdentityClaims=function(){var e=this._storage.getItem("id_token_claims_obj");return e?JSON.parse(e):null},n.prototype.getGrantedScopes=function(){var e=this._storage.getItem("granted_scopes");return e?JSON.parse(e):null},n.prototype.getIdToken=function(){return this._storage?this._storage.getItem("id_token"):null},n.prototype.padBase64=function(e){for(;e.length%4!=0;)e+="=";return e},n.prototype.getAccessToken=function(){return this._storage?this._storage.getItem("access_token"):null},n.prototype.getRefreshToken=function(){return this._storage?this._storage.getItem("refresh_token"):null},n.prototype.getAccessTokenExpiration=function(){return this._storage.getItem("expires_at")?parseInt(this._storage.getItem("expires_at"),10):null},n.prototype.getAccessTokenStoredAt=function(){return parseInt(this._storage.getItem("access_token_stored_at"),10)},n.prototype.getIdTokenStoredAt=function(){return parseInt(this._storage.getItem("id_token_stored_at"),10)},n.prototype.getIdTokenExpiration=function(){return this._storage.getItem("id_token_expires_at")?parseInt(this._storage.getItem("id_token_expires_at"),10):null},n.prototype.hasValidAccessToken=function(){if(this.getAccessToken()){var e=this._storage.getItem("expires_at"),t=new Date;return!(e&&parseInt(e,10)<t.getTime())}return!1},n.prototype.hasValidIdToken=function(){if(this.getIdToken()){var e=this._storage.getItem("id_token_expires_at"),t=new Date;return!(e&&parseInt(e,10)<t.getTime())}return!1},n.prototype.authorizationHeader=function(){return"Bearer "+this.getAccessToken()},n.prototype.logOut=function(e){void 0===e&&(e=!1);var t=this.getIdToken();if(this._storage.removeItem("access_token"),this._storage.removeItem("id_token"),this._storage.removeItem("refresh_token"),this._storage.removeItem("nonce"),this._storage.removeItem("expires_at"),this._storage.removeItem("id_token_claims_obj"),this._storage.removeItem("id_token_expires_at"),this._storage.removeItem("id_token_stored_at"),this._storage.removeItem("access_token_stored_at"),this._storage.removeItem("granted_scopes"),this._storage.removeItem("session_state"),this.silentRefreshSubject=null,this.eventsSubject.next(new A("logout")),this.logoutUrl&&!e&&(t||this.postLogoutRedirectUri)){var n;if(!this.validateUrlForHttps(this.logoutUrl))throw new Error("logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if(this.logoutUrl.indexOf("{{")>-1)n=this.logoutUrl.replace(/\{\{id_token\}\}/,t).replace(/\{\{client_id\}\}/,this.clientId);else{var o=new r.HttpParams;t&&(o=o.set("id_token_hint",t));var i=this.postLogoutRedirectUri||this.redirectUri;i&&(o=o.set("post_logout_redirect_uri",i)),n=this.logoutUrl+(this.logoutUrl.indexOf("?")>-1?"&":"?")+o.toString()}this.config.openUri(n)}},n.prototype.createAndSaveNonce=function(){var e=this;return this.createNonce().then(function(t){return e._storage.setItem("nonce",t),t})},n.prototype.ngOnDestroy=function(){this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.removeSilentRefreshEventListener();var e=document.getElementById(this.silentRefreshIFrameName);e&&e.remove(),this.stopSessionCheckTimer(),this.removeSessionCheckEventListener();var t=document.getElementById(this.sessionCheckIFrameName);t&&t.remove()},n.prototype.createNonce=function(){var e=this;return new Promise(function(t){if(e.rngUrl)throw new Error("createNonce with rng-web-api has not been implemented so far");var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=45,o="",i="undefined"==typeof self?null:self.crypto||self.msCrypto;if(i){var s=new Uint8Array(r);i.getRandomValues(s),s=s.map(function(e){return n.charCodeAt(e%n.length)}),o=String.fromCharCode.apply(null,s)}else for(;0<r--;)o+=n[Math.random()*n.length|0];t(_(o))})},n.prototype.checkAtHash=function(e){return h(this,void 0,void 0,function(){return d(this,function(t){return this.tokenValidationHandler?[2,this.tokenValidationHandler.validateAtHash(e)]:(this.logger.warn("No tokenValidationHandler configured. Cannot check at_hash."),[2,!0])})})},n.prototype.checkSignature=function(e){return this.tokenValidationHandler?this.tokenValidationHandler.validateSignature(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check signature."),Promise.resolve(null))},n.prototype.initLoginFlow=function(e,t){return void 0===e&&(e=""),void 0===t&&(t={}),"code"===this.responseType?this.initCodeFlow(e,t):this.initImplicitFlow(e,t)},n.prototype.initCodeFlow=function(e,t){var n=this;void 0===e&&(e=""),void 0===t&&(t={}),""!==this.loginUrl?this.initCodeFlowInternal(e,t):this.events.pipe(i.filter(function(e){return"discovery_document_loaded"===e.type})).subscribe(function(r){return n.initCodeFlowInternal(e,t)})},n.prototype.initCodeFlowInternal=function(e,t){if(void 0===e&&(e=""),void 0===t&&(t={}),!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");this.createLoginUrl(e,"",null,!1,t).then(this.config.openUri)["catch"](function(e){console.error("Error in initAuthorizationCodeFlow"),console.error(e)})},n.prototype.createChallangeVerifierPairForPKCE=function(){return h(this,void 0,void 0,function(){var e,t;return d(this,function(n){switch(n.label){case 0:if(!this.crypto)throw new Error("PKCI support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?");return[4,this.createNonce()];case 1:return e=n.sent(),[4,this.crypto.calcHash(e,"sha-256")];case 2:return t=n.sent(),[2,[_(t),e]]}})})},n=c([t.Injectable(),u(2,t.Optional()),u(3,t.Optional()),u(4,t.Optional()),u(7,t.Optional()),l("design:paramtypes",[t.NgZone,r.HttpClient,v,b,E,S,m,U])],n)}(E),R=function(){return function(){}}(),L=function(){return function(){}}(),F=function(){return function(){}}(),O=function(){function e(){}return e.prototype.handleError=function(e){return o.throwError(e)},e}(),D=function(){function e(e,t,n,r){this.authStorage=e,this.oAuthService=t,this.errorHandler=n,this.moduleConfig=r}return e.prototype.checkUrl=function(e){return this.moduleConfig.resourceServer.customUrlValidation?this.moduleConfig.resourceServer.customUrlValidation(e):!this.moduleConfig.resourceServer.allowedUrls||!!this.moduleConfig.resourceServer.allowedUrls.find(function(t){return e.startsWith(t)})},e.prototype.intercept=function(e,t){var n=this,r=e.url.toLowerCase();return this.moduleConfig&&this.moduleConfig.resourceServer&&this.checkUrl(r)?this.moduleConfig.resourceServer.sendAccessToken?o.merge(o.of(this.oAuthService.getAccessToken()).pipe(i.filter(function(e){return!!e})),this.oAuthService.events.pipe(i.filter(function(e){return"token_received"===e.type}),i.timeout(this.oAuthService.waitForTokenInMsec||0),i.catchError(function(e){return o.of(null)}),i.map(function(e){return n.oAuthService.getAccessToken()}))).pipe(i.take(1),i.mergeMap(function(r){if(r){var o="Bearer "+r,s=e.headers.set("Authorization",o);e=e.clone({headers:s})}return t.handle(e).pipe(i.catchError(function(e){return n.errorHandler.handleError(e)}))})):t.handle(e).pipe(i.catchError(function(e){return n.errorHandler.handleError(e)})):t.handle(e)},e=c([t.Injectable(),u(3,t.Optional()),l("design:paramtypes",[v,j,F,R])],e)}(),N=function(){function e(){}return e.prototype.validateSignature=function(e){return Promise.resolve(null)},e.prototype.validateAtHash=function(e){return Promise.resolve(!0)},e}();function V(){return console}function M(){return"undefined"!=typeof sessionStorage?sessionStorage:new y}var q=function(){function e(){}var o;return o=e,e.forRoot=function(e,t){return void 0===e&&(e=null),void 0===t&&(t=N),{ngModule:o,providers:[j,S,{provide:m,useFactory:V},{provide:v,useFactory:M},{provide:b,useClass:t},{provide:U,useClass:x},{provide:F,useClass:O},{provide:R,useValue:e},{provide:r.HTTP_INTERCEPTORS,useClass:D,multi:!0}]}},e=o=c([t.NgModule({imports:[n.CommonModule],declarations:[],exports:[]})],e)}(),B="PLEASE READ THIS CAREFULLY:\n\nBeginning with angular-oauth2-oidc version 9, the JwksValidationHandler\nhas been moved to an library of its own. If you need it for implementing\nOAuth2/OIDC **implicit flow**, please install it using npm:\n\n  npm i angular-oauth2-oidc-jwks --save\n\nAfter that, you can import it into your application:\n\n  import { JwksValidationHandler } from 'angular-oauth2-oidc-jwks';\n\nPlease note, that this dependency is not needed for the **code flow**,\nwhich is nowadays the **recommented** one for single page applications.\nThis also results in smaller bundle sizes.\n",Q=function(e){function t(){var t=e.call(this)||this;return console.error(B),t}return a(t,e),t}(N),J=new t.InjectionToken("AUTH_CONFIG");e.AUTH_CONFIG=J,e.AbstractValidationHandler=T,e.AuthConfig=E,e.DefaultOAuthInterceptor=D,e.JwksValidationHandler=Q,e.LoginOptions=g,e.MemoryStorage=y,e.NullValidationHandler=N,e.OAuthErrorEvent=H,e.OAuthEvent=I,e.OAuthInfoEvent=A,e.OAuthLogger=m,e.OAuthModule=q,e.OAuthModuleConfig=R,e.OAuthNoopResourceServerErrorHandler=O,e.OAuthResourceServerConfig=L,e.OAuthResourceServerErrorHandler=F,e.OAuthService=j,e.OAuthStorage=v,e.OAuthSuccessEvent=C,e.ReceivedTokens=k,e.UrlHelperService=S,e.ValidationHandler=b,e.ɵa=U,e.ɵb=x,e.ɵc=V,e.ɵd=M,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=angular-oauth2-oidc.umd.min.js.map